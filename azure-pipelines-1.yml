trigger:
- master
- create-odata-cli-pipeline

name: 'OData CLI'

pool:
  vmImage: 'windows-latest'

variables:
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  rootDir: '$(Build.SourcesDirectory)'
  sln: '$(rootDir)\OData.Cli.sln'
  signigConfigPath: '$(rootDir)\configs'
  signingConfigFiles: '*.*'
  productBinPath: '$(rootDir)\src\Microsoft.OData.Cli\bin\$(BuildConfiguration)'
  productFiles: 'odata-cli.*?(*.dll|*.config|*.pdb)'
  nupkgPath: '$(Build.ArtifactStagingDirectory)'
  nupkgFile: 'Microsoft.OData.Cli.0.1.0.nupkg'
  signingFiles: 'odata-cli.dll'
  mainDll: 'odata-cli.dll'
  snExe: 'C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\sn.exe'
  snExe64: 'C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\x64\sn.exe'

stages:
- stage: Build

  jobs:
  - job: Build
    steps:

    - task: NuGetToolInstaller@0
      inputs:
        versionSpec: '>=5.2.0'

    - task: NuGetCommand@2
      displayName: 'Nuget restore - OData.Cli.sln'
      inputs:
        restoreSolution: '$(sln)'

    - task: VSBuild@1
      displayName: 'Build solution - OData.Cli.sln'
      inputs:
        solution: '$(sln)'
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: 'Pack Microsoft.OData.Cli package'
      inputs:
        command: pack
        packagesToPack: src/Microsoft.OData.Cli/Microsoft.OData.Cli.csproj
        nobuild: true

    - task: CopyFiles@2
      displayName: 'Copy Files - NuGet package to Artifacts Staging'
      inputs:
        SourceFolder: '$(Build.ArtifactStagingDirectory)'
        Contents: 'Microsoft.OData.Cli.0.1.0.nupkg'
        TargetFolder: '$(Build.ArtifactStagingDirectory)\Nupkg'
        OverWrite: true

    - task: EsrpCodeSigning@1
      displayName: 'ESRP CodeSigning Nuget Packages'
      inputs:
        ConnectedServiceName: 'ESRP CodeSigning - OData'
        FolderPath: '$(Build.ArtifactStagingDirectory)\Nupkg'
        Pattern: '*.nupkg'
        signConfigType: inlineSignParams
        inlineOperation: |
          [
            {
              "keyCode": "CP-401405",
              "operationSetCode": "NuGetSign",
              "parameters": [ ],
              "toolName": "sign",
              "toolVersion": "1.0"
            },
            {
              "keyCode": "CP-401405",
              "operationSetCode": "NuGetVerify",
              "parameters": [ ],
              "toolName": "sign",
              "toolVersion": "1.0"
            }
          ]

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact - Nuget Packages'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\Nupkg'
        ArtifactName: Nupkg
        publishLocation: 'Container'
